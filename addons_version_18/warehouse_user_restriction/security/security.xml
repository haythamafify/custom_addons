<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="group_warehouse_restriction_user" model="res.groups">
        <field name="name">Warehouse Restriction User</field>
        <field name="category_id" ref="base.module_category_inventory"/>
        <field name="implied_ids" eval="[(4, ref('stock.group_stock_user'))]"/>
    </record>

    <record id="group_warehouse_restriction_manager" model="res.groups">
        <field name="name">Warehouse Restriction Manager</field>
        <field name="category_id" ref="base.module_category_inventory"/>
        <field name="implied_ids" eval="[(4, ref('group_warehouse_restriction_user')), (4, ref('stock.group_stock_manager'))]"/>
    </record>

    <!--
        Warehouse rule:
        Users can read/update/create/delete only warehouses assigned on res.users.warehouse_ids,
        and only inside their allowed companies.
    -->
    <record id="rule_stock_warehouse_user_restriction" model="ir.rule">
        <field name="name">Warehouse: user allowed warehouses only</field>
        <field name="model_id" ref="stock.model_stock_warehouse"/>
        <field name="domain_force">[(1, '=', 1)] if user.has_group('base.group_system') else [
            ('id', 'in', user.warehouse_ids.ids),
            ('company_id', 'in', user.company_ids.ids)
        ]</field>
    </record>

    <!--
        Stock Picking rule:
        Users can access pickings related to their warehouses by operation type warehouse,
        source location tree, or destination location tree.
        Company isolation is enforced in the same domain.
    -->
    <record id="rule_stock_picking_user_restriction" model="ir.rule">
        <field name="name">Picking: user warehouse scope only</field>
        <field name="model_id" ref="stock.model_stock_picking"/>
        <field name="domain_force">[(1, '=', 1)] if user.has_group('base.group_system') else [
            ('company_id', 'in', user.company_ids.ids),
            '|', '|',
            ('picking_type_id.warehouse_id', 'in', user.warehouse_ids.ids),
            ('location_id', 'child_of', user.warehouse_ids.view_location_id.ids),
            ('location_dest_id', 'child_of', user.warehouse_ids.view_location_id.ids)
        ]</field>
    </record>

    <!--
        Stock Quant rule:
        Users can access quants only in locations under the view location of their warehouses.
        Company isolation is enforced in the same domain.
    -->
    <record id="rule_stock_quant_user_restriction" model="ir.rule">
        <field name="name">Quant: user warehouse location tree only</field>
        <field name="model_id" ref="stock.model_stock_quant"/>
        <field name="domain_force">[(1, '=', 1)] if user.has_group('base.group_system') else [
            ('company_id', 'in', user.company_ids.ids),
            ('location_id', 'child_of', user.warehouse_ids.view_location_id.ids)
        ]</field>
    </record>

    <!--
        Stock Location rule:
        Users can access locations only under the warehouse view locations assigned to them.
        Shared locations without company are allowed only if they are in the allowed tree.
    -->
    <record id="rule_stock_location_user_restriction" model="ir.rule">
        <field name="name">Location: user warehouse location tree only</field>
        <field name="model_id" ref="stock.model_stock_location"/>
        <field name="domain_force">[(1, '=', 1)] if user.has_group('base.group_system') else [
            ('id', 'child_of', user.warehouse_ids.view_location_id.ids),
            '|',
            ('company_id', '=', False),
            ('company_id', 'in', user.company_ids.ids)
        ]</field>
    </record>
</odoo>
